#!/usr/bin/env bash

set -euo pipefail

[ "$UID" -eq 0 ] || { echo "This script must be run as root."; exit 1;}

dot-stow

echo
echo "==> Ensuring fish is the default shell..."
echo

if cat /etc/shells | grep /opt/homebrew/bin/fish &>/dev/null; then
  echo "Fish is already in /etc/shells"
else
  echo "Adding fish to /etc/shells..."
  echo /opt/homebrew/bin/fish >> /etc/shells
fi

if [ "${SHELL}" == "/opt/homebrew/bin/fish" ]; then
  echo "Fish is already your \$SHELL"
else
  echo "Making fish your current \$SHELL..."
  sudo -u kylekthompson chsh -s /opt/homebrew/bin/fish
fi

echo
echo "==> Insalling Mac App Store apps..."
echo

echo "Installing Amphetamine..."
sudo -u kylekthompson mas install 937984704

echo "Installing Magnet..."
sudo -u kylekthompson mas install 441258766

echo "Installing Clocker..."
sudo -u kylekthompson mas install 1056643111

echo
echo "==> Updating and upgrading brew..."
echo

sudo -u kylekthompson brew bundle check --global &>/dev/null || sudo -u kylekthompson brew bundle --global
sudo -u kylekthompson brew update
sudo -u kylekthompson brew upgrade

echo
echo "==> Installing default tools via mise"
echo

pushd ~ &>/dev/null

sudo -u kylekthompson mise install

if ! command -v claude &>/dev/null; then
  echo
  echo "==> Installing claude code"
  echo

  sudo -u kylekthompson curl -fsSL https://claude.ai/install.sh | sudo -u kylekthompson bash
fi

popd &>/dev/null
